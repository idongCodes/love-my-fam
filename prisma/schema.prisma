// 1. CONFIGURATION
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// 2. USER MODEL
model User {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  alias     String?
  position  String
  email     String   @unique
  phone     String?
  profileImage String?
  createdAt DateTime @default(now())

  // Relations
  posts        Post[]        @relation("UserPosts")
  comments     Comment[]
  likes        Like[]
  commentLikes CommentLike[]
  Testimonial  Testimonial[]
}

// 3. POST MODEL
model Post {
  id        String   @id @default(cuid())
  content   String
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)

  // Relations
  authorId String
  author   User      @relation("UserPosts", fields: [authorId], references: [id])
  comments Comment[]
  likes    Like[]
}

// 4. POST LIKE MODEL
model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  postId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId]) // A user can only like a post once
}

// 5. COMMENT MODEL (Supports Recursion & Editing)
model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt // Tracks when it was edited
  isEdited  Boolean  @default(false) // Tracks if it was edited

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Recursive Relations (Replies)
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  children Comment[] @relation("CommentReplies")

  // Likes on Comments
  likes CommentLike[]
}

// 6. COMMENT LIKE MODEL
model CommentLike {
  id String @id @default(cuid())

  userId    String
  commentId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId]) // A user can only like a comment once
}

// 7. TESTIMONIAL MODEL
model Testimonial {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  authorId String
  author   User   @relation(fields: [authorId], references: [id])
}
